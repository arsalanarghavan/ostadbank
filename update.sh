#!/bin/bash

# ูุณุฑ ูพุฑูฺู
PROJECT_DIR="/opt/ostadbank"
GIT_REPO_URL="https://github.com/arsalanarghavan/ostadbank.git"

# ุจุฑุฑุณ ุฏุณุชุฑุณ root
if [ "$(id -u)" -ne 0 ]; then
  echo "โ ุงู ุงุณฺฉุฑูพุช ุจุงุฏ ุจุง ุฏุณุชุฑุณ root ุง sudo ุงุฌุฑุง ุดูุฏ."
  exit 1
fi

echo "๐ ุดุฑูุน ูุฑุขูุฏ ุฏุงูููุฏ/ุขูพุฏุช ุฑุจุงุช..."

# ุจุฑุฑุณ ูุฌูุฏ ูพูุดู ูพุฑูฺู
if [ ! -d "$PROJECT_DIR" ]; then
    echo "๐ ูพูุดู ูพุฑูฺู ุงูุช ูุดุฏ. ุฏุฑ ุญุงู ฺฉููู ฺฉุฑุฏู ุงุฒ ฺฏุชโูุงุจ..."
    git clone $GIT_REPO_URL $PROJECT_DIR
    if [ $? -ne 0 ]; then
        echo "โ ุฎุทุง ุฏุฑ ฺฉููู ฺฉุฑุฏู ูพุฑูฺู."
        exit 1
    fi
    echo "โ ูพุฑูฺู ุจุง ููููุช ฺฉููู ุดุฏ."
else
    echo "๐ ูพูุดู ูพุฑูฺู ูุฌูุฏ ุฏุงุฑุฏ. ุฏุฑ ุญุงู ุขูพุฏุช ฺฉุฑุฏู ุจุง git pull..."
    cd $PROJECT_DIR
    git pull origin main # ุง ูุฑ ุดุงุฎู ุฏฺฏุฑ ฺฉู ูุฏ ูุธุฑุชุงู ุงุณุช
    if [ $? -ne 0 ]; then
        echo "โ๏ธ ูุดุฏุงุฑ ุฏุฑ ููฺฏุงู git pull ุฑุฎ ุฏุงุฏ (ููฺฉู ุงุณุช ุจู ุฏูู ูุฌูุฏ ุชุบุฑุงุช ะปะพะบะฐะปัะฝัะน ุจุงุดุฏ). ุชูุงุด ุจุฑุง ุฑุณุช ฺฉุฑุฏู..."
        git fetch --all
        git reset --hard origin/main
    fi
    echo "โ ูพุฑูฺู ุจุง ููููุช ุขูพุฏุช ุดุฏ."
fi

# ูุตุจ ุง ุขูพุฏุช ูพฺฉุฌโูุง ูพุงุชูู
echo "๐ ุขูพุฏุช ฺฉุฑุฏู ูพฺฉุฌโูุง ููุฑุฏ ูุงุฒ..."
cd $PROJECT_DIR
source venv/bin/activate
pip install -r requirements.txt
deactivate

# ุฑโุงุณุชุงุฑุช ฺฉุฑุฏู ุณุฑูุณ ุฑุจุงุช
echo "โ๏ธ ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ุณุฑูุณ ุฑุจุงุช..."
systemctl restart ostadbank.service

# ุจุฑุฑุณ ูุถุนุช ููุง ุณุฑูุณ
echo "โณ ุจุฑุฑุณ ูุถุนุช ููุง ุณุฑูุณ..."
sleep 3
STATUS=$(systemctl is-active ostadbank.service)

if [ "$STATUS" = "active" ]; then
    echo -e "\n๐ **ุนููุงุช ุจุง ููููุช ุงูุฌุงู ุดุฏ!**"
    echo "โ ุฑุจุงุช ุดูุง ุงฺฉููู ุจุง ุขุฎุฑู ุชุบุฑุงุช ุฏุฑ ุญุงู ุงุฌุฑุง ุงุณุช."
else
    echo -e "\n\nโ๏ธ **ุฎุทุง ุฏุฑ ุงุฌุฑุง ุฑุจุงุช!**"
    echo "ุณุฑูุณ ุฑุจุงุช ูุชูุงูุณุช ุงุฌุฑุง ุดูุฏ. ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ:"
    echo "   journalctl -u ostadbank -f"
fi